# Промисы

## Определение

**Promise** или **промис** – особый объект, предназначенный для обозначения результата [асинхронной](async_basics.md) операции. Содержит свое состояние и позволяет добавить обработчики успешного или неуспешного завершения операции. 

## Состояния

* Pending – промис еще не отмечен выполненным, "операция в процессе"
* Fulfilled – промис отмечен выполненным успешно
* Rejected – промис отмечен выполненным с ошибкой

> Промис, состояние которого переведено из `pending` в любое другое, больше не может менять свое состояние. 

## Способ использования

* Код, который "планирует" делать что-то асинхронное, создает промис и передает его "ожидающему" (обычно внешнему для функции) коду
* Внешний код вешает обработчики на промис
* При завершении операций асинхронный код отмечает промис выполненным, вызываются обработчики

## Создание промиса

Promise создается с помощью конструктора `Promise`. Ему передается функция, которая и будет совершать асинхронные операции. Она будет вызвана автоматически, и в неё будет передано два аргумента: 

1. Функция, которую нужно вызвать, чтобы отметить промис выполненным успешно (обычно называют `resolve`)

2. Функция, которую нужно вызвать, чтобы отметить промис выполненным с ошибкой (обычно. называют `reject`)

   > Кстати, выброс [ошибки](errors.md) из промиса будет аналогичен вызову `reject`

```javascript
const promise = new Promise((resolve, reject) => {
  // Тут выполняются любые операции
  // Когда операции завершены, вызывается resolve или reject:
  readFile(file, (err, data) => {
    if (err) {
      reject(err);
    } else {
      resolve(data);
    }
  })
});
```

```javascript
function asyncSum(a, b) {
	return new Promise((resolve) => {
    setTimeout(() => {
      resolve(a + b);
    }, 5000);
  });
}

asyncSum(1, 3)
  .then(result => console.log(result));
```

## Добавление обработчиков

Когда промис создан, на него можно повесить обработчики, которые будут вызваны, когда промис выполнится. Для этого есть два метода:

* `then` – вызовет обработчик, когда промис завершится успешно
* `catch` – вызовет обработчик, когда промис завершится с ошибкой

Оба этих метода принимают функцию-обработчик:

```javascript
promise
	.then((data) => {
  	console.log(data);
	})
	.catch((err) => {
  	console.error(err);
	});
```

Функция из `then` будет вызвана с теми данными, которые будут переданы в `resolve`, а функция из `catch` – с данными из `reject`.

> Обработчики можно добавить и тогда, когда промис уже успел завершиться. Тогда обработчик будет вызван сразу. 